#compdef _amir amir

_amir() {
    local cur prev context state line
    cur="${words[CURRENT]}"
    prev="${words[CURRENT-1]}"

    # Step 1: Main commands
    if (( CURRENT == 2 )); then
        local -a commands
        commands=(
            'init-project:Scaffold Agent Constitution in directory'
            'compress:Compress video(s) or directory (e.g. file1 file2 OR ./folder)'
            'mp3:Extract or change audio quality'
            'img:Resize images (logo and custom sizes)'
            'pdf:Convert images to single A4 PDF'
            'info:Show file technical properties'
            'transfer:Upload temporary file and get link'
            'lock:Encrypt and lock file'
            'unlock:Unlock encrypted file'
            'clean:Clean system caches and trash'
            'qr:Create smart QR Code'
            'weather:Show weather information'
            'short:Shorten long URLs'
            'pass:Generate secure password'
            'speed:Test internet speed'
            'todo:Manage quick task list'
            'clip:Copy text or file to clipboard'
            'chat:Ask Gemini/Gemma anything'
            'code:Generate code and save to file'
            'watermark:Add logo or text watermark to images/videos'
            'subtitle:Generate multi-language subtitles using AI'
        )
        _describe -t commands 'amir commands' commands
        return
    fi

    # Step 2: Subcommand options
    case "${words[2]}" in
        # (Existing cases...)

        watermark)
            if (( CURRENT >= 3 )); then
                _arguments \
                    '-o[Output file path]:output file:_files' \
                    '-i[Watermark image path]:watermark image:_files' \
                    '-t[Watermark text]:text' \
                    '-p[Position]:position:(SE SW NE NW C)' \
                    '*:input file:_files'
            fi
            ;;

        compress)
            if (( CURRENT == 3 )); then
                _alternative \
                    'files:Video Files or Directories (Space separated):_files' \
                    'commands:Management Commands:((stats\:Show\ AI\ learning\ statistics reset\:Reset\ AI\ learning\ data codecs\:Check\ HEVC\ codec\ support))'
            elif (( CURRENT >= 4 )); then
                local prev="${words[CURRENT-1]}"
                prev="${(Q)prev}" # Unquote special chars
                
                # logic: If previous arg was a number, user is likely typing next number (quality) or done.
                # If previous arg was a Directory, switch to settings (STOP offering files to break loop).
                # If previous arg was a File, offer more files OR settings.
                
                if [[ -d "$prev" ]]; then
                    # Previous was directory -> Mode: Batch -> Expecting Resolution FIRST.
                    _amir_resolutions
                elif [[ "$prev" =~ ^[0-9]+$ ]]; then
                     if [[ "$prev" -gt 100 ]]; then
                        # Previous was Resolution (e.g. 720, 1080) -> Suggest Quality next
                        _amir_qualities
                     else
                        # Previous was Quality (e.g. 40, 60) -> We assume command is ready.
                        # Stop suggesting Resolutions to prevent looping/confusion as requested.
                        _message "âœ… Ready to execute! (Press Enter)"
                     fi
                else
                    # Previous was file (or other) -> Can add more files OR Start Resolution selection
                    # We hide Quality here to force "File -> Resolution -> Quality" flow for cleanliness, unless user skips Res.
                    # But to keep it clean as requested:
                    _alternative \
                        'files:More Video Files:_files -g "*.(mp4|mov|mkv|avi|MP4|MOV|MKV|webm|WEBM)"' \
                        'resolutions:Resolution Options:_amir_resolutions'
                fi
            fi
            ;;

        mp3)
            case $((CURRENT)) in
                3)
                    # Audio/video files (audio extraction)
                    _files -g "*.(mp4|mov|mkv|avi|mp3|wav|flac|m4a|MP3|WAV|FLAC|M4A)"
                    ;;
                4)
                    # Bitrate options
                    _amir_bitrates
                    ;;
            esac
            ;;

        img)
            local subcmd="${words[3]}"
            
            if [[ "$subcmd" == "resize" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _amir_img_sizes ;;
                    6) 
                        local -a options
                        options=('circle:Circular crop output (PNG)')
                        _describe -t options 'option' options
                        ;;
                esac
            elif [[ "$subcmd" == "crop" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _amir_img_sizes ;;
                    6) _amir_img_gravity ;;
                esac
            elif [[ "$subcmd" == "pad" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _amir_img_sizes ;;
                    6) _amir_colors ;;
                esac
            elif [[ "$subcmd" == "convert" ]]; then
                 case $((CURRENT)) in
                    4) _files ;;
                    5) 
                        local -a formats
                        formats=('png' 'jpg' 'jpeg' 'webp')
                        _describe -t formats 'Output Format' formats 
                        ;;
                    6) _amir_img_sizes ;;
                    7|*) 
                        # Check previous argument for context
                        if [[ "${words[CURRENT-1]}" == "-bg" || "${words[CURRENT-1]}" == "--background" ]]; then
                            _amir_bg_colors
                        else
                            # Offer Flags/Options recursively
                            local -a convert_opts
                            convert_opts=(
                                'circle:Circular crop output (PNG)'
                                '-bg:Background Color (Default: Transparent)'
                                '--background:Background Color (Default: Transparent)'
                            )
                            # Passing the array name to _describe
                            _describe -t convert_opts 'option' convert_opts
                        fi
                        ;;
                esac
            elif [[ "$subcmd" == "extend" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    *)
                        _arguments \
                            '1:input image file:_files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)"' \
                            '(-c --color)'{-c,--color}'[Global background color]:color' \
                            '(-t --top)'{-t,--top}'[Top padding pixels]:pixels' \
                            '(-b --bottom)'{-b,--bottom}'[Bottom padding pixels]:pixels' \
                            '(-l --left)'{-l,--left}'[Left padding pixels]:pixels' \
                            '(-r --right)'{-r,--right}'[Right padding pixels]:pixels'
                        ;;
                esac
            elif [[ "$subcmd" == "round" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _message "Corner Radius (px) [default: 20]" ;;
                esac
            else
                # Default / Legacy / Autocomplete selection
                case $((CURRENT)) in
                    3)
                         local -a img_actions
                         img_actions=(
                            'resize:Simple resize (no crop)'
                            'crop:Resize and crop to fill'
                            'pad:Resize and fill background'
                            'round:Round image corners (PNG)'
                            'extend:Extend image borders with custom color'
                            'convert:Convert image to png/jpg'
                         )
                         # Show both subcommands and files (without _alternative nesting issues)
                         _describe -t img_actions "action" img_actions
                         ;;
                    4)
                        # Legacy size
                         _amir_img_sizes
                        ;;
                    5)
                        # Legacy Gravity
                        _amir_img_gravity
                        ;;
                esac
            fi
            ;;


        
        init-project)
             if (( CURRENT == 3 )); then
                _files -/ # Directories only
             fi
             ;;

        info|transfer|lock|unlock|clip)
            if (( CURRENT == 3 )); then
                _files # Any files
            fi
            ;;

        qr)
            case $((CURRENT)) in
                3) _message "Enter URL, phone number, email or text" ;;
                4) _message "Output filename (optional)" ;;
            esac
            ;;

        weather)
            if (( CURRENT == 3 )); then
                _message "City name (default: Tehran)"
            fi
            ;;

        short)
            case $((CURRENT)) in
                3)
                    _message "Enter long URL to shorten"
                    ;;
                4)
                    local -a flags
                    flags=(
                        '--debug:Show services being tried'
                        '-d:Show services being tried'
                    )
                    _describe -t flags 'options' flags
                    ;;
            esac
            ;;

        pass)
            if (( CURRENT == 3 )); then
                _message "Password length (default: 16)"
            fi
            ;;

        speed)
            _message "Testing internet speed..."
            ;;

        todo)
            case $((CURRENT)) in
                3)
                    local -a todo_opts
                    todo_opts=(
                        'add:Add new task'
                        'done:Mark task as done'
                        'list:Show all tasks'
                        'clear:Clear all tasks'
                    )
                    _describe -t todo_opts 'todo command' todo_opts
                    ;;
                4)
                    if [[ "${words[3]}" == "done" ]]; then
                        _message "Enter task number to mark done"
                    elif [[ "${words[3]}" == "add" ]]; then
                        _message "Enter task description"
                    fi
                    ;;
            esac
            ;;

        chat)
            if (( CURRENT == 2 )); then
                # Suggest history switch in the first argument
                _arguments ': :(--history)'
            else
                # Chat guide in subsequent arguments
                _message "ðŸ’¬ Ask Gemini/Gemma anything..."
            fi
            ;;

        code)
            if (( CURRENT == 2 )); then
                # Suggest history switch or file/clipboard selection
                _arguments ': :(--history clip)'
                _files
            else
                # Coding guide
                _message "ðŸ’» Describe the refactoring or logic you want..."
            fi
            ;;
        pdf)
            _arguments \
                {-o,--output}'[Specify output file]:filename:_files' \
                {-r,--rotate}'[Rotate images (degrees)]:angle' \
                {-q,--quality}'[JPEG Quality (default: 60)]:quality (0-100)' \
                '--resize[Resize percentage (default: 50)]:percentage' \
                '--radius[Corner radius (px)]:pixels' \
                '--no-round[Disable corner rounding]' \
                '--square[Alias for --no-round]' \
                '*:images:_files'
            ;;
        subtitle)
            case $((CURRENT)) in
                3)
                    # 3: Video File
                    _files -g "*.(mp4|mov|mkv|avi|MP4|MOV|MKV|webm|WEBM)"
                    ;;
                4|5)
                    # 4: Suggest -s flag
                    # 5: Suggest Source Lang (value of -s)
                    # We only include -s here so user is guided to pick it first.
                    _arguments -s \
                        '1: : ' \
                        '(-s --source)'{-s,--source}'[Source language code (default: en)]:source language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)'
                    ;;
                6|7)
                    # 6: Suggest -t flag (since -s is done)
                    # 7: Suggest Target Lang (value of -t)
                    # We include -s (so Zsh knows it's already there) and add -t.
                    _arguments -s \
                        '1: : ' \
                        '(-s --source)'{-s,--source}'[Source language code (default: en)]:source language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)' \
                        '(-t --target)'{-t,--target}'[Target language code(s)]:target language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)'
                    ;;
                8)
                    # 8: Suggest -r flag
                    _arguments -s \
                        '1: : ' \
                        '(-s --source)'{-s,--source}'[Source language code (default: en)]:source language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)' \
                        '(-t --target)'{-t,--target}'[Target language code(s)]:target language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)' \
                        '(-r --render)'{-r,--render}'[Render video with embedded subtitles]'
                    ;;
                *)
                    # 9+: All options available
                    _arguments -s \
                        '1: : ' \
                        '(-s --source)'{-s,--source}'[Source language code (default: en)]:source language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)' \
                        '(-t --target)'{-t,--target}'[Target language code(s)]:target language:(en fa ar es fr de it pt ru ja ko zh hi tr nl)' \
                        '(-m --model)'{-m,--model}'[Whisper model size]:model:(tiny base small medium large)' \
                        '(-r --render)'{-r,--render}'[Render video with embedded subtitles]' \
                        '(-f --force-transcribe)'{-f,--force-transcribe}'[Force re-transcription]' \
                        '--deepseek-transcribe[Use DeepSeek API for transcription]' \
                        '--no-correction[Disable automatic transcription correction]' \
                        '(-l --list-languages)'{-l,--list-languages}'[List all supported languages]'
                    ;;
            esac
            ;;
        clean)
            _message "Cleaning system temporary files..."
            ;;
    esac
}

# --- Helper Functions ---

_amir_resolutions() {
    local -a resolutions
    resolutions=(
        '240:Very low quality (Fast transfer)'
        '360:Medium quality (Mobile)'
        '480:Medium quality (Standard SD)'
        '720:Good quality (Standard HD)'
        '1080:Excellent quality (Full HD)'
    )
    _describe -t resolutions 'resolution options' resolutions
}

_amir_qualities() {
    local -a qualities
    qualities=(
        '40:Smallest file (max compression)'
        '50:Very High compression'
        '60:Balanced (Default)'
        '70:High Quality'
        '80:Excellent Quality'
    )
    _describe -t qualities 'quality factor (40-80)' qualities
}

_amir_bitrates() {
    local -a bitrates
    bitrates=(
        '320:Highest quality (standard MP3)'
        '256:High quality (more clarity)'
        '192:Very good quality (balanced)'
        '160:Good quality (standard)'
        '128:Medium quality (podcasts)'
        '96:Low quality (voice only)'
    )
    _describe -t bitrates 'bitrate (kbps)' bitrates
}

_amir_img_sizes() {
    local -a img_sizes
    img_sizes=(
        '2560x1440:YouTube Channel Banner'
        '2048:Very large size (4K)'
        '1024:Large size (HD)'
        '800x800:YouTube Channel Logo'
        '600:Lottery photo size'
        '512:High quality (profile)'
        '400x120:GitHub Logo'
        '256:Web & app size'
        '150x150:YouTube Video Watermark'
        '128:Medium logo size'
        '64:Small icon'
        '48:Standard icon'
        '32:Very small icon'
        '16:Favicon'
    )
    _describe -V -t img_sizes 'image size (px)' img_sizes 
}

_amir_img_gravity() {
    local -a matrix
    matrix=('7:Top-Left' '8:Top' '9:Top-Right' '4:Left' '5:Center' '6:Right' '1:Bot-Left' '2:Bot' '3:Bot-Right')
    _describe -t matrix 'Gravity' matrix
}

_amir_colors() {
    local -a colors
    colors=('white' 'black' 'transparent' 'red' 'blue' '#ffffff' '#000000')
    _describe -t colors 'Background Color' colors
}

_amir_bg_colors() {
    local -a bg_colors
    bg_colors=(
        'transparent:Transparent (Default)' 
        'white:White Background' 
        'black:Black Background' 
        '#ff0000:Hex Red'
        '#0000ff:Hex Blue'
    )
    _describe -t bg_colors 'Background Color' bg_colors
}

_amir "$@"