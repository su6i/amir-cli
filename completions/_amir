#compdef _amir amir

_amir() {
    local cur prev
    cur="${words[CURRENT]}"
    prev="${words[CURRENT-1]}"

    # Step 1: Main commands
    if (( CURRENT == 2 )); then
        local -a commands
        commands=(
            'batch:Batch process all videos in folder'
            'init-project:Scaffold Agent Constitution in directory'
            'compress:Compress video with custom resolution'
            'mp3:Extract or change audio quality'
            'img:Resize images (logo and custom sizes)'
            'info:Show file technical properties'
            'transfer:Upload temporary file and get link'
            'lock:Encrypt and lock file'
            'unlock:Unlock encrypted file'
            'clean:Clean system caches and trash'
            'qr:Create smart QR Code'
            'weather:Show weather information'
            'short:Shorten long URLs'
            'pass:Generate secure password'
            'speed:Test internet speed'
            'todo:Manage quick task list'
            'clip:Copy text or file to clipboard'
            'chat:Ask Gemini/Gemma anything'
            'code:Generate code and save to file'
            'watermark:Add logo or text watermark to images/videos'
        )
        _describe -t commands 'amir commands' commands
        return
    fi

    # Step 2: Subcommand options
    case "${words[2]}" in
        # (Existing cases...)

        watermark)
            if (( CURRENT >= 3 )); then
                _arguments \
                    '-o[Output file path]:output file:_files' \
                    '-i[Watermark image path]:watermark image:_files' \
                    '-t[Watermark text]:text' \
                    '-p[Position]:position:(SE SW NE NW C)' \
                    '*:input file:_files'
            fi
            ;;

        compress)
            if (( CURRENT == 3 )); then
                local -a subcmds
                subcmds=(
                    'stats:Show AI learning statistics'
                    'reset:Reset AI learning data'
                    'codecs:Check HEVC codec support'
                )
                _alternative \
                    'files:Video Files:_files -g "*.(mp4|mov|mkv|avi|MP4|MOV|MKV|webm|WEBM)"' \
                    'commands:Management Commands:_describe -t subcmds "Management Commands" subcmds'
            elif (( CURRENT == 4 )); then
                # Resolution options (only if arg 3 looks like a file)
                # Use (Q) to unquote the filename (handle spaces/escapes)
                if [[ -f "${(Q)words[3]}" ]]; then
                    local -a resolutions
                    resolutions=(
                        '240:Very low quality (Fast transfer)'
                        '360:Medium quality (Mobile)'
                        '480:Medium quality (Standard SD)'
                        '720:Good quality (Standard HD)'
                        '1080:Excellent quality (Full HD)'
                    )
                    _describe -t resolutions 'resolution options' resolutions
                fi
            elif (( CURRENT == 5 )); then
                # Quality options
                if [[ -f "${(Q)words[3]}" ]]; then
                     local -a qualities
                     qualities=(
                        '40:Smallest file (max compression)'
                        '50:Very High compression'
                        '60:Balanced (Default)'
                        '70:High Quality'
                        '80:Excellent Quality'
                     )
                     _describe -t qualities 'quality factor (40-80)' qualities
                fi
            fi
            ;;

        mp3)
            case $((CURRENT)) in
                3)
                    # Audio/video files (audio extraction)
                    _files -g "*.(mp4|mov|mkv|avi|mp3|wav|flac|m4a|MP3|WAV|FLAC|M4A)"
                    ;;
                4)
                    # Bitrate options
                    local -a bitrates
                    bitrates=(
                        '320:Highest quality (standard MP3)'
                        '256:High quality (more clarity)'
                        '192:Very good quality (balanced)'
                        '160:Good quality (standard)'
                        '128:Medium quality (podcasts)'
                        '96:Low quality (voice only)'
                    )
                    _describe -t bitrates 'bitrate (kbps)' bitrates
                    ;;
            esac
            ;;

        img)
            local subcmd="${words[3]}"
            
            # Shared size definitions
            local -a img_sizes
            img_sizes=(
                '2048:Very large size (4K)'
                '1024:Large size (HD)'
                '600:Lottery photo size'
                '512:High quality (profile)'
                '400x120:GitHub Logo'
                '256:Web & app size'
                '128:Medium logo size'
                '64:Small icon'
                '48:Standard icon'
                '32:Very small icon'
                '16:Favicon'
            )

            if [[ "$subcmd" == "resize" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _describe -V -t img_sizes 'image size (px)' img_sizes ;;
                esac
            elif [[ "$subcmd" == "crop" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _describe -V -t img_sizes 'image size (px)' img_sizes ;;
                    6)
                        local -a matrix
                        matrix=('7:Top-Left' '8:Top' '9:Top-Right' '4:Left' '5:Center' '6:Right' '1:Bot-Left' '2:Bot' '3:Bot-Right')
                        _describe -t matrix 'Gravity' matrix
                        ;;
                esac
            elif [[ "$subcmd" == "pad" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _describe -V -t img_sizes 'image size (px)' img_sizes ;;
                    6)
                        colors=('white' 'black' 'transparent' 'red' 'blue' '#ffffff' '#000000')
                        _describe -t colors 'Background Color' colors
                        ;;
                esac
            elif [[ "$subcmd" == "convert" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(svg|SVG|jpg|jpeg|png|webp)" ;;
                    5) 
                        local -a formats
                        formats=('png' 'jpg' 'jpeg' 'webp')
                        _describe -t formats 'Output Format' formats 
                        ;;
                    6) _describe -V -t img_sizes 'Max Size (px)' img_sizes ;;
                esac
            elif [[ "$subcmd" == "extend" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    *)
                        _arguments \
                            '1:input image file:_files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)"' \
                            '(-c --color)'{-c,--color}'[Global background color]:color' \
                            '(-t --top)'{-t,--top}'[Top padding pixels]:pixels' \
                            '(-b --bottom)'{-b,--bottom}'[Bottom padding pixels]:pixels' \
                            '(-l --left)'{-l,--left}'[Left padding pixels]:pixels' \
                            '(-r --right)'{-r,--right}'[Right padding pixels]:pixels'
                        ;;
                esac
            else
                # Default / Legacy / Autocomplete selection
                case $((CURRENT)) in
                    3)
                         local -a img_actions
                         img_actions=(
                            'resize:Simple resize (no crop)'
                            'crop:Resize and crop to fill'
                            'pad:Resize and fill background'
                            'extend:Extend image borders with custom color'
                            'convert:Convert image to png/jpg'
                         )
                         # Show both subcommands and files (without _alternative nesting issues)
                         _describe -t img_actions "action" img_actions
                         ;;
                    4)
                        # Legacy size
                        _describe -V -t img_sizes 'image size (px)' img_sizes 
                        ;;
                    5)
                        # Legacy Gravity
                        local -a matrix
                        matrix=('7:Top-Left' '8:Top' '9:Top-Right' '4:Left' '5:Center' '6:Right' '1:Bot-Left' '2:Bot' '3:Bot-Right')
                        _describe -t matrix 'Gravity' matrix
                        ;;
                esac
            fi
            ;;

        batch)
            case $((CURRENT)) in
                3)
                    # Batch resolution options
                    local -a batch_res
                    batch_res=(
                        '1080:All videos to 1080p'
                        '720:All videos to 720p'
                        '480:All videos to 480p'
                        '360:All videos to 360p'
                        '240:All videos to 240p'
                    )
                    _describe -t batch_res 'batch resolution' batch_res
                    ;;
                4)
                    # Target directory
                    _files -/ # Directories only
                    ;;
            esac
            ;;
        
        init-project)
             if (( CURRENT == 3 )); then
                _files -/ # Directories only
             fi
             ;;

        info|transfer|lock|unlock|clip)
            if (( CURRENT == 3 )); then
                _files # Any files
            fi
            ;;

        qr)
            case $((CURRENT)) in
                3) _message "Enter URL, phone number, email or text" ;;
                4) _message "Output filename (optional)" ;;
            esac
            ;;

        weather)
            if (( CURRENT == 3 )); then
                _message "City name (default: Tehran)"
            fi
            ;;

        short)
            case $((CURRENT)) in
                3)
                    _message "Enter long URL to shorten"
                    ;;
                4)
                    local -a flags
                    flags=(
                        '--debug:Show services being tried'
                        '-d:Show services being tried'
                    )
                    _describe -t flags 'options' flags
                    ;;
            esac
            ;;

        pass)
            if (( CURRENT == 3 )); then
                _message "Password length (default: 16)"
            fi
            ;;

        speed)
            _message "Testing internet speed..."
            ;;

        todo)
            case $((CURRENT)) in
                3)
                    local -a todo_opts
                    todo_opts=(
                        'add:Add new task'
                        'done:Mark task as done'
                        'list:Show all tasks'
                        'clear:Clear all tasks'
                    )
                    _describe -t todo_opts 'todo command' todo_opts
                    ;;
                4)
                    if [[ "${words[3]}" == "done" ]]; then
                        _message "Enter task number to mark done"
                    elif [[ "${words[3]}" == "add" ]]; then
                        _message "Enter task description"
                    fi
                    ;;
            esac
            ;;

        chat)
            if (( CURRENT == 2 )); then
                # Ÿæ€åÿ¥ŸÜŸáÿßÿØ ÿ≥Ÿà€å€å⁄Ü ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿØÿ± ÿßŸàŸÑ€åŸÜ ÿ¢ÿ±⁄ØŸàŸÖÿßŸÜ
                _arguments ': :(--history)'
            else
                # ÿ±ÿßŸáŸÜŸÖÿß€å ŸÖÿÆÿµŸàÿµ ⁄Üÿ™ ÿØÿ± ÿ¢ÿ±⁄ØŸàŸÖÿßŸÜ‚ÄåŸáÿß€å ÿ®ÿπÿØ€å
                _message "üí¨ Ask Gemini/Gemma anything..."
            fi
            ;;

        code)
            if (( CURRENT == 2 )); then
                # Ÿæ€åÿ¥ŸÜŸáÿßÿØ ÿ≥Ÿà€å€å⁄Ü ÿ™ÿßÿ±€åÿÆ⁄ÜŸá €åÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÅÿß€åŸÑ/⁄©ŸÑ€åŸæ‚Äåÿ®Ÿàÿ±ÿØ
                _arguments ': :(--history clip)'
                _files
            else
                # ÿ±ÿßŸáŸÜŸÖÿß€å ŸÖÿÆÿµŸàÿµ ⁄©ÿØŸÜŸà€åÿ≥€å
                _message "üíª Describe the refactoring or logic you want..."
            fi
            ;;
        clean)
            _message "Cleaning system temporary files..."
            ;;
    esac
}

_amir "$@"