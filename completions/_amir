#compdef _amir amir

_amir() {
    local cur prev context state line
    cur="${words[CURRENT]}"
    prev="${words[CURRENT-1]}"

    # Step 1: Main commands
    if (( CURRENT == 2 )); then
        local -a commands
        commands=(
            'init-project:Scaffold Agent Constitution in directory'
            'compress:Compress video(s) or directory (e.g. file1 file2 OR ./folder)'
            'audio:Audio tools (extract, concat, to-video)'
            'img:Resize images (logo and custom sizes)'
            'pdf:Convert images to single A4 PDF'
            'info:Show file technical properties'
            'transfer:Upload temporary file and get link'
            'lock:Encrypt and lock file'
            'unlock:Unlock encrypted file'
            'clean:Clean system caches and trash'
            'qr:Create smart QR Code'
            'weather:Show weather information'
            'short:Shorten long URLs'
            'pass:Generate secure password'
            'speed:Test internet speed'
            'todo:Manage quick task list'
            'clip:Copy text or file to clipboard'
            'chat:Ask Gemini/Gemma anything'
            'code:Generate code and save to file'
            'watermark:Add logo or text watermark to images/videos'
            'subtitle:Generate multi-language subtitles using AI'
            'llm-lists:Fetch model lists from LLM providers'
        )
        _describe -t commands 'amir commands' commands
        return
    fi

    # Step 2: Subcommand options
    case "${words[2]}" in
        
        pdf)
            case $((CURRENT)) in
                *)
                    # PDF command: Uses standard argument parsing
                    _arguments -s \
                        '--smart[Smart Crop (content-aware trimming)]' \
                        '--engine[Specify rendering engine]:engine:(puppeteer weasyprint pil pandoc)' \
                        '--weasyprint[Use WeasyPrint engine]' \
                        '--pil[Use PIL grayscale fallback engine]' \
                        '--pandoc[Use Pandoc engine]' \
                        {-o,--output}'[Specify output file]:filename:_files' \
                        {-r,--rotate}'[Rotate images (degrees)]:angle' \
                        {-q,--quality}'[JPEG Quality (default: 60)]:quality (0-100)' \
                        '--resize[Resize percentage (default: 50)]:percentage' \
                        '--pages[Create multi-page PDF (1 image per page) instead of collage]' \
                        '--radius[Corner radius (px)]:pixels' \
                        '--no-round[Disable corner rounding]' \
                        '--square[Alias for --no-round]' \
                        '--no-deskew[Disable auto-straightening]' \
                        '--no-straighten[Alias for --no-deskew]' \
                        '*:images:_files -g "*.(jpg|jpeg|png|webp|pdf|md|txt|JPG|PNG|WEBP|PDF|MD|TXT)"'
                    ;;
            esac
            ;;

        watermark)
            if (( CURRENT >= 3 )); then
                _arguments \
                    '-o[Output file path]:output file:_files' \
                    '-i[Watermark image path]:watermark image:_files' \
                    '-t[Watermark text]:text' \
                    '-p[Position]:position:(SE SW NE NW C)' \
                    '*:input file:_files'
            fi
            ;;

        compress)
            local first_arg="${words[3]}"
            if (( CURRENT == 3 )); then
                _alternative \
                    'commands:Management Command:((stats\:Show\ AI\ learning\ statistics reset\:Reset\ AI\ learning\ data codecs\:Check\ HEVC\ codec\ support batch\:Batch\ process\ all\ videos))' \
                    'files:Video File:_path_files -f -g "*.mp4 *.mov *.mkv *.avi *.MP4 *.MOV *.MKV *.webm *.WEBM"'
            elif [[ "$first_arg" == "batch" ]]; then
                case $((CURRENT)) in
                    4) _files -/ ;; # BATCH only shows directories
                    5) _amir_resolutions ;;
                    6) _amir_qualities ;;
                    *) _message "Ready!" ;;
                esac
            elif (( CURRENT >= 4 )); then
                local prev="${words[CURRENT-1]}"
                prev="${(Q)prev}" # Unquote special chars
                
                # If we picked a management subcommand, don't suggest resolutions
                if [[ "$first_arg" == "stats" || "$first_arg" == "reset" || "$first_arg" == "codecs" ]]; then
                    _message "Ready to execute!"
                    return
                fi

                if [[ "$prev" =~ ^[0-9]+$ || "$PREFIX" == "-"* ]]; then
                     if [[ "$prev" -gt 100 ]]; then
                        _amir_qualities
                     else
                        _amir_qualities
                     fi
                else
                    # Priority: Resolutions
                    _amir_resolutions
                fi
            fi
            ;;

        audio)
            local subcmd="${words[3]}"
            # Force grouping and formatting for this context
            # This ensures headers appear directly above items instead of bunched at the top
            zstyle ":completion:${curcontext}:*" group-name ''
            zstyle ":completion:${curcontext}:*" format '-- %d --'

            if (( CURRENT == 3 )); then
                _alternative \
                    'acmds:Audio Command:((extract\:Extract\ audio\ from\ video\ file concat\:Join\ multiple\ audio\ files to-video\:Create\ video\ from\ audio\ and\ image))' \
                    'afolders:Audio Folder:_files -/'
            else
                case "$subcmd" in
                    extract)
                        case $((CURRENT)) in
                            4) _files -g "*.(mp4|mov|mkv|avi|webm|flv|MP4|MOV|MKV)" ;;
                            5) _amir_bitrates ;;
                        esac
                        ;;
                    concat)
                        case "$prev" in
                            -o|--output) _files ;;
                            *) _files -g "*.(mp3|wav|m4a|flac|aac|MP3|WAV)" ;;
                        esac
                        ;;
                    to-video)
                        case "$prev" in
                            -i|--image) _files -g "*.(jpg|jpeg|png|webp|JPG|PNG)" ;;
                            -o|--output) _files ;;
                            *) 
                                if [[ "$PREFIX" == -* ]]; then
                                    local -a tv_opts
                                    tv_opts=(
                                        '-i:Background image'
                                        '--image:Background image'
                                        '-o:Output video file'
                                        '--output:Output video file'
                                        '--waveform:Add dynamic waveform visualization'
                                    )
                                    _describe -t tv_opts 'options' tv_opts
                                else
                                    _files -g "*.(mp3|wav|m4a|flac|aac|MP3|WAV)"
                                fi
                                ;;
                        esac
                        ;;
                esac
            fi
            ;;

        img)
            local subcmd="${words[3]}"
            
            if [[ "$subcmd" == "resize" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _amir_img_sizes ;;
                    6) 
                        local -a options
                        options=('circle:Circular crop output (PNG)')
                        _describe -t options 'option' options
                        ;;
                esac
            elif [[ "$subcmd" == "crop" ]]; then
                 
                 # Handle flags
                 if [[ "$PREFIX" == -* ]]; then
                     local -a crop_flags
                     crop_flags=(
                '--smart:Smart Crop (Content-Aware)'
                        '--preview:Preview Mode (Visualize detection)'
                        '--expand:Expansion/Dilation (Default: 4)'
                        '--margin:Safety Margin px (Default: 20)'
                        '--gravity:Gravity'
                        '-g:Gravity'
                     )
                     _describe -t crop_flags 'option' crop_flags && return 0
                 fi
                 
                 if [[ "$prev" == "-g" || "$prev" == "--gravity" ]]; then
                    _amir_img_gravity && return 0
                 fi

                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) 
                        local -a smart_opts
                        smart_opts=(
                            '--smart:Smart Scan (Document detection)'
                            '--preview:Preview Scan (Visualize detection)'
                            '--tuning:Tuning Mode (Generates variations)'
                            '--expand:Kernel Size for Morphology (Default: 21)'
                            '--margin:Safety Margin px (Default: 20)'
                        )
                        _describe -t smart_opts 'Smart Mode' smart_opts
                        _amir_img_sizes 
                        ;;
                    6) _amir_img_gravity ;;
                esac
            elif [[ "$subcmd" == "pad" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _amir_img_sizes ;;
                    6) _amir_colors ;;
                esac

            elif [[ "$subcmd" == "rotate" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _message "Rotation Angle (degrees)" ;;
                esac
            elif [[ "$subcmd" == "convert" ]]; then
                 case $((CURRENT)) in
                    4) _files ;;
                    5) 
                        local -a formats
                        formats=('png' 'jpg' 'jpeg' 'webp')
                        _describe -t formats 'Output Format' formats 
                        ;;
                    6) _amir_img_sizes ;;
                    7|*) 
                        if [[ "${words[CURRENT-1]}" == "-bg" || "${words[CURRENT-1]}" == "--background" ]]; then
                            _amir_bg_colors
                        else
                            local -a convert_opts
                            convert_opts=(
                                'circle:Circular crop output (PNG)'
                                '-bg:Background Color (Default: Transparent)'
                                '--background:Background Color (Default: Transparent)'
                            )
                            _describe -t convert_opts 'option' convert_opts
                        fi
                        ;;
                esac
            elif [[ "$subcmd" == "extend" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    *)
                        _arguments \
                            '1:input image file:_files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)"' \
                            '(-c --color)'{-c,--color}'[Global background color]:color' \
                            '(-t --top)'{-t,--top}'[Top padding pixels]:pixels' \
                            '(-b --bottom)'{-b,--bottom}'[Bottom padding pixels]:pixels' \
                            '(-l --left)'{-l,--left}'[Left padding pixels]:pixels' \
                            '(-r --right)'{-r,--right}'[Right padding pixels]:pixels'
                        ;;
                esac
            elif [[ "$subcmd" == "round" ]]; then
                 case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _message "Corner Radius (px) [default: 20]" ;;
                    6) 
                        local -a round_formats
                        round_formats=('jpg' 'png')
                        _describe -t round_formats 'format' round_formats
                        ;;
                esac
            elif [[ "$subcmd" == "stack" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;  # First image
                    5) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;  # Second image
                    *)
                        # Check if previous word is -p, show paper sizes
                        if [[ "${words[CURRENT-1]}" == "-p" || "${words[CURRENT-1]}" == "--paper" ]]; then
                            local -a paper_sizes
                            paper_sizes=(
                                'a4:A4 size (210x297mm at 150dpi)'
                                'b5:B5 size (176x250mm at 150dpi)'
                            )
                            _describe -t paper_sizes 'paper size' paper_sizes
                        else
                            # After 2 files, show only options
                            local -a stack_options
                            stack_options=(
                                '-g:Gap between images in pixels (default 20)'
                                '-bg:Background color (default white)'
                                '-o:Output filename (default {first}_stacked.jpg)'
                                '-p:Paper size preset (a4 or b5, 150dpi)'
                                '--deskew:Auto-correct skewed scans'
                            )
                            _describe -t stack_options 'options' stack_options
                        fi
                        ;;
                esac
            elif [[ "$subcmd" == "deskew" ]]; then
                case $((CURRENT)) in
                    4) _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" ;;
                    5) _files ;; # Output file
                esac
            elif [[ "$subcmd" == "lab" ]]; then
                case "$prev" in
                    -s|--scale)
                        _describe -t scales 'scale' "(1:Quality\ enhancement\ (no\ resize) 2:Upscale\ 2x 4:Upscale\ 4x)" && return 0
                        ;;
                    -m|--model)
                        _describe -t models 'model' "(all:Test\ all\ models ultrasharp digital-art high-fidelity upscayl-standard upscayl-lite remacri ultramix-balanced)" && return 0
                        ;;
                    *)
                        # If the command line already contains a file (at position 4), suggest only flags
                        if [[ -n "${words[4]}" && "${words[4]}" != -* ]]; then
                            local -a lab_opts
                            lab_opts=(
                                '-s:Upscale factor (1, 2, 4)'
                                '--scale:Upscale factor (1, 2, 4)'
                                '-m:AI Model'
                                '--model:AI Model'
                            )
                            _describe -t lab_opts 'option' lab_opts && return 0
                        else
                            # Otherwise, suggest files
                            _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" && return 0
                        fi
                        ;;
                esac
            elif [[ "$subcmd" == "scan" ]]; then
                case "$prev" in
                    -o|--output)
                        _files && return 0
                        ;;
                    *)
                        # If the command line already contains a target file, suggest only flags
                        if [[ -n "${words[4]}" && "${words[4]}" != -* ]]; then
                             local -a scan_flags
                             scan_flags=(
                                '--fast:Quick Scan (Level 1)'
                                '--pro:Professional BW Scan (Level 2)'
                                '--ocr:OCR-Grade Grayscale Scan (Level 3)'
                                '--py:High-Fidelity Python/OpenCV Scan'
                                '--all:Generate all variations for comparison'
                                '-o:Output filename'
                                '--output:Output filename'
                             )
                             _describe -t scan_flags 'option' scan_flags && return 0
                        fi

                        if [[ "$PREFIX" == -* ]]; then
                            local -a scan_opts
                            scan_opts=(
                                '--fast:Quick Scan (Level 1)'
                                '--pro:Professional BW Scan (Level 2)'
                                '--ocr:OCR-Grade Grayscale Scan (Level 3)'
                                '--py:High-Fidelity Python/OpenCV Scan'
                                '--all:Generate all variations for comparison'
                                '-o:Output filename'
                                '--output:Output filename'
                            )
                            _describe -t scan_opts 'option' scan_opts && return 0
                        else
                            _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)" && return 0
                        fi
                        ;;
                esac
            elif [[ "$subcmd" == "burst" ]]; then
                case "$prev" in
                    -o|--output)
                        _files && return 0
                        ;;
                    *)
                        if [[ "$PREFIX" == -* ]]; then
                            local -a burst_opts
                            burst_opts=(
                                '-r:Recursive directory search'
                                '--recursive:Recursive directory search'
                                '-o:Output filename'
                                '--output:Output filename'
                            )
                            _describe -t burst_opts 'option' burst_opts && return 0
                        else
                            _files -g "*.(jpg|jpeg|png|webp|tiff|JPG|JPEG|PNG|WEBP|TIFF)" && return 0
                        fi
                        ;;
                esac
            else
                case $((CURRENT)) in
                    3)
                         local -a img_actions
                         img_actions=(
                            'resize:Simple resize (no crop)'
                            'crop:Resize and crop to fill'
                            'pad:Resize and fill background'
                            'rotate:Rotate image by angle (degrees)'
                            'round:Round image corners (PNG)'
                            'stack:Combine multiple images vertically'
                            'upscale:AI-Upscale image (2x, 3x, 4x or 1x enhancement)'
                            'lab:Generate 60/420 enhancement combinations for testing'
                            'scan:Professional document cleanup (White BG, Black Ink)'
                            'burst:Multi-frame State of the Art Reconstruction'
                            'extend:Extend image borders with custom color'
                            'convert:Convert image to png/jpg'
                            'deskew:Auto-straighten image'
                         )
                         _describe -t img_actions "action" img_actions
                         ;;
                     4) 
                        if [[ "$subcmd" == "upscale" ]]; then
                            _files -g "*.(jpg|jpeg|png|webp|svg|JPG|PNG|WEBP|SVG)"
                        else
                            _amir_img_sizes
                        fi
                        ;;
                    5) 
                        if [[ "$subcmd" == "upscale" ]]; then
                            local -a scales; scales=('1:Quality enhancement (no resize)' '2:Upscale 2x' '3:Upscale 3x' '4:Upscale 4x'); _describe -t scales "scale" scales
                        else
                            _amir_img_gravity
                        fi
                        ;;
                    6)
                        if [[ "$subcmd" == "upscale" ]]; then
                            local -a models; models=('all:Test all models' 'ultrasharp' 'digital-art' 'high-fidelity' 'upscayl-standard' 'upscayl-lite' 'remacri' 'ultramix-balanced'); _describe -t models "model" models
                        fi
                        ;;
                esac
            fi
            ;;

        init-project)
             if (( CURRENT == 3 )); then
                _files -/ 
             fi
             ;;

        info|transfer|lock|unlock|clip)
            if (( CURRENT == 3 )); then
                _files 
            fi
            ;;

        qr)
            case $((CURRENT)) in
                3) _message "Enter URL, phone number, email or text" ;;
                4) _message "Output filename (optional)" ;;
            esac
            ;;

        weather)
            if (( CURRENT == 3 )); then
                _message "City name (default: Tehran)"
            fi
            ;;

        short)
            case $((CURRENT)) in
                3)
                    _message "Enter long URL to shorten"
                    ;;
                4)
                    local -a flags
                    flags=(
                        '--debug:Show services being tried'
                        '-d:Show services being tried'
                    )
                    _describe -t flags 'options' flags
                    ;;
            esac
            ;;

        pass)
            if (( CURRENT == 3 )); then
                _message "Password length (default: 16)"
            fi
            ;;

        speed)
            _message "Testing internet speed..."
            ;;

        todo)
            case $((CURRENT)) in
                3)
                    local -a todo_opts
                    todo_opts=(
                        'add:Add new task'
                        'done:Mark task as done'
                        'list:Show all tasks'
                        'clear:Clear all tasks'
                    )
                    _describe -t todo_opts 'todo command' todo_opts
                    ;;
                4)
                    if [[ "${words[3]}" == "done" ]]; then
                        _message "Enter task number to mark done"
                    elif [[ "${words[3]}" == "add" ]]; then
                        _message "Enter task description"
                    fi
                    ;;
            esac
            ;;

        chat)
            if (( CURRENT == 2 )); then
                _arguments ': :(--history)'
            else
                _message "ðŸ’¬ Ask Gemini/Gemma anything..."
            fi
            ;;

        code)
            if (( CURRENT == 2 )); then
                _arguments ': :(--history clip)'
                _files
            else
                _message "ðŸ’» Describe the refactoring or logic you want..."
            fi
            ;;
        
        subtitle)
            case $((CURRENT)) in
                3)
                    _files -g "*.(mp4|mov|mkv|avi|MP4|MOV|MKV|webm|WEBM)"
                    ;;
                *)
                    _arguments -s \
                        '1:video file:_files -g "*.(mp4|mov|mkv|avi|MP4|MOV|MKV|webm|WEBM)"' \
                        '(-s --source)'{-s,--source}'[Source language code (default: en)]:source language:(en zh es hi ar bn pt ru ja fr ur pa vi tr ko id de fa gu it mr te ta th ha el he mg nl pl uk)' \
                        '(-t --target)'{-t,--target}'[Target language code(s)]:target language:(en zh es hi ar bn pt ru ja fr ur pa vi tr ko id de fa gu it mr te ta th ha el he mg nl pl uk)' \
                        '(-m --model)'{-m,--model}'[Whisper model size]:model:(tiny base small medium large large-v2 large-v3)' \
                        '(-r --render)'{-r,--render}'[Render video with embedded subtitles]' \
                        '(-c --continue)'{-c,--continue}'[Resume incomplete translation]' \
                        '--subtitle[Path to an existing subtitle file (SRT/ASS)]:subtitle file:_files -g "*.(srt|ass|SRT|ASS)"' \
                        '--no-translate[Skip translation step]' \
                        '--no-correction[Disable automatic transcription correction]' \
                        '--deepseek-transcribe[Use DeepSeek API for transcription]' \
                        '(-f --force-transcribe)'{-f,--force-transcribe}'[Force re-transcription]' \
                        '(-l --list-languages)'{-l,--list-languages}'[List all supported languages]'
                    ;;
            esac
            ;;
        
        llm-lists)
            case $((CURRENT)) in
                3)
                    local -a providers
                    providers=(
                        'gemini:Google Gemini models'
                        'openai:OpenAI GPT models'
                        'deepseek:DeepSeek models'
                        'groq:Groq models'
                        'anthropic:Claude models'
                    )
                    _describe -t providers 'LLM provider' providers
                    ;;
                4)
                    local -a export_opts
                    export_opts=(
                        '-e:Export format'
                        '--export:Export format'
                    )
                    _describe -t export_opts 'options' export_opts
                    ;;
                5)
                    if [[ "${words[4]}" == "-e" || "${words[4]}" == "--export" ]]; then
                        local -a formats
                        formats=(
                            'pdf:Export as PDF'
                            'md:Export as Markdown'
                            'jpg:Export as image'
                        )
                        _describe -t formats 'export format' formats
                    fi
                    ;;
            esac
            ;;
        clean)
            _message "Cleaning system temporary files..."
            ;;
    esac
}

# --- Helper Functions ---

_amir_resolutions() {
    local -a resolutions
    resolutions=(
        '240:Very low quality (Fast transfer)'
        '360:Medium quality (Mobile)'
        '480:Medium quality (Standard SD)'
        '720:Good quality (Standard HD)'
        '1080:Excellent quality (Full HD)'
    )
    _describe -t resolutions 'resolution options' resolutions
}

_amir_qualities() {
    local -a qualities
    qualities=(
        '40:Smallest file (max compression)'
        '50:Very High compression'
        '60:Balanced (Default)'
        '70:High Quality'
        '80:Excellent Quality'
    )
    _describe -t qualities 'quality factor (40-80)' qualities
}

_amir_bitrates() {
    local -a bitrates
    bitrates=(
        '320:Highest quality (standard MP3)'
        '256:High quality (more clarity)'
        '192:Very good quality (balanced)'
        '160:Good quality (standard)'
        '128:Medium quality (podcasts)'
        '96:Low quality (voice only)'
    )
    _describe -t bitrates 'bitrate (kbps)' bitrates
}

_amir_img_sizes() {
    local -a img_sizes
    img_sizes=(
        '2560x1440:YouTube Channel Banner'
        '2048:Very large size (4K)'
        '1024:Large size (HD)'
        '800x800:YouTube Channel Logo'
        '600:Lottery photo size'
        '512:High quality (profile)'
        '400x120:GitHub Logo'
        '256:Web & app size'
        '150x150:YouTube Video Watermark'
        '128:Medium logo size'
        '64:Small icon'
        '48:Standard icon'
        '32:Very small icon'
        '16:Favicon'
    )
    _describe -V -t img_sizes 'image size (px)' img_sizes 
}

_amir_img_gravity() {
    local -a matrix
    matrix=('7:Top-Left' '8:Top' '9:Top-Right' '4:Left' '5:Center' '6:Right' '1:Bot-Left' '2:Bot' '3:Bot-Right')
    _describe -t matrix 'Gravity' matrix
}

_amir_colors() {
    local -a colors
    colors=('white' 'black' 'transparent' 'red' 'blue' '#ffffff' '#000000')
    _describe -t colors 'Background Color' colors
}


_amir_bg_colors() {
    local -a bg_colors
    bg_colors=(
        'transparent:Transparent (Default)' 
        'white:White Background' 
        'black:Black Background' 
        '#ff0000:Hex Red'
        '#0000ff:Hex Blue'
    )
    _describe -t bg_colors 'Background Color' bg_colors
}

_amir "$@"