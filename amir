#!/bin/bash

# ==============================================================================
# Amir CLI - A powerful video compression and utility tool
# Author: Su6i (Refactored)
# ==============================================================================

# Ensure standard paths (including Homebrew) are in PATH
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# Get the absolute path of the script directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
    DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
LIB_DIR="$SCRIPT_DIR/lib"

# Allow `--no-venv` to skip auto-activation and optional install prompt
NO_VENV=0
if [[ "$1" == "--no-venv" ]]; then
    NO_VENV=1
    shift
fi

# Activate project virtualenv if present so Python invocations use it
if [[ $NO_VENV -eq 0 ]]; then
    if [[ -f "$SCRIPT_DIR/.venv/bin/activate" ]]; then
        # shellcheck disable=SC1090
        source "$SCRIPT_DIR/.venv/bin/activate"
    else
        # Prompt user to create/install venv on first run
        echo "⚠️  Virtual environment not found at $SCRIPT_DIR/.venv"
        read -r -p "Would you like to run ./install.sh --auto now to create it? [Y/n] " resp
        resp=${resp:-Y}
        if [[ "$resp" =~ ^([yY][eE][sS]|[yY])$ ]]; then
            bash "$SCRIPT_DIR/install.sh" --auto
            if [[ -f "$SCRIPT_DIR/.venv/bin/activate" ]]; then
                # shellcheck disable=SC1090
                source "$SCRIPT_DIR/.venv/bin/activate"
            else
                echo "⚠️  Installation finished but .venv not found or activation failed. Continuing without venv."
            fi
        else
            echo "ℹ️  Continuing without virtualenv (use --no-venv to skip this prompt)."
        fi
    fi
else
    echo "ℹ️  --no-venv set: skipping virtualenv activation." >&2
fi

# ==============================================================================
# Automatic Dependency Resolution (Self-Healing)
# ==============================================================================
check_deps_fast() {
    for tool in ffmpeg ffprobe bc qrencode uv; do
        if ! command -v "$tool" >/dev/null 2>&1; then
            return 1
        fi
    done
    return 0
}

if ! check_deps_fast; then
    bash "$SCRIPT_DIR/install.sh" --auto
fi

# Load Environment Variables if .env exists
if [[ -f "$SCRIPT_DIR/.env" ]]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

# ==============================================================================
# Global Utilities (Maintained in core library)
# ==============================================================================

if [[ -f "$LIB_DIR/amir_lib.sh" ]]; then
    source "$LIB_DIR/amir_lib.sh"
else
    echo "❌ Core library not found: $LIB_DIR/amir_lib.sh"
    exit 1
fi

# ==============================================================================
# Subcommand Dispatcher
# ==============================================================================

COMMAND="$1"

case "$COMMAND" in

    # install-full removed: handled by root install.sh
    
    # === Migrated Commands ===
    
    compress)
        shift
        if [[ -f "$LIB_DIR/commands/compress.sh" ]]; then
            source "$LIB_DIR/commands/compress.sh"
            run_compress "$@"
            exit $?
        fi
        ;;
    
    mp3)
        shift
        if [[ -f "$LIB_DIR/commands/audio.sh" ]]; then source "$LIB_DIR/commands/audio.sh"; run_audio "extract" "$@"; exit $?; fi
        ;;
    init-project)
        shift
        if [[ -f "$LIB_DIR/commands/init-project.sh" ]]; then source "$LIB_DIR/commands/init-project.sh"; run_init_project "$@"; exit $?; fi
        ;;
    pdf)
        shift
        if [[ -f "$LIB_DIR/commands/pdf.sh" ]]; then "$LIB_DIR/commands/pdf.sh" "$@"; exit $?; fi
        ;;
    info)
        shift
        if [[ -f "$LIB_DIR/commands/info.sh" ]]; then source "$LIB_DIR/commands/info.sh"; run_info "$@"; exit $?; fi
        ;;
    img)
        shift
        if [[ -f "$LIB_DIR/commands/img.sh" ]]; then source "$LIB_DIR/commands/img.sh"; run_img "$@"; exit $?; fi
        ;;
    transfer)
        shift
        if [[ -f "$LIB_DIR/commands/transfer.sh" ]]; then source "$LIB_DIR/commands/transfer.sh"; run_transfer "$@"; exit $?; fi
        ;;
    lock)
        shift
        if [[ -f "$LIB_DIR/commands/lock.sh" ]]; then source "$LIB_DIR/commands/lock.sh"; run_lock "$@"; exit $?; fi
        ;;
    unlock)
        shift
        if [[ -f "$LIB_DIR/commands/lock.sh" ]]; then source "$LIB_DIR/commands/lock.sh"; run_unlock "$@"; exit $?; fi
        ;;
    clean)
        if [[ -f "$LIB_DIR/commands/clean.sh" ]]; then source "$LIB_DIR/commands/clean.sh"; run_clean; exit $?; fi
        ;;
    qr)
        shift
        if [[ -f "$LIB_DIR/commands/qr.sh" ]]; then source "$LIB_DIR/commands/qr.sh"; run_qr "$@"; exit $?; fi
        ;;
    weather)
        shift
        if [[ -f "$LIB_DIR/commands/weather.sh" ]]; then source "$LIB_DIR/commands/weather.sh"; run_weather "$@"; exit $?; fi
        ;;
    short)
        shift
        if [[ -f "$LIB_DIR/commands/short.sh" ]]; then source "$LIB_DIR/commands/short.sh"; run_short "$@"; exit $?; fi
        ;;
    pass)
        shift
        if [[ -f "$LIB_DIR/commands/pass.sh" ]]; then source "$LIB_DIR/commands/pass.sh"; run_pass "$@"; exit $?; fi
        ;;
    speed)
        if [[ -f "$LIB_DIR/commands/speed.sh" ]]; then source "$LIB_DIR/commands/speed.sh"; run_speed; exit $?; fi
        ;;
    todo)
        shift
        if [[ -f "$LIB_DIR/commands/todo.sh" ]]; then source "$LIB_DIR/commands/todo.sh"; run_todo "$@"; exit $?; fi
        ;;
    clip)
        shift
        if [[ -f "$LIB_DIR/commands/clip.sh" ]]; then source "$LIB_DIR/commands/clip.sh"; run_clip "$@"; exit $?; fi
        ;;
    chat)
        shift
        if [[ -f "$LIB_DIR/commands/chat.sh" ]]; then source "$LIB_DIR/commands/chat.sh"; run_chat "$@"; exit $?; fi
        ;;
    code)
        shift
        if [[ -f "$LIB_DIR/commands/code.sh" ]]; then source "$LIB_DIR/commands/code.sh"; run_code "$@"; exit $?; fi
        ;;
    dashboard)
        if [[ -f "$LIB_DIR/commands/dashboard.sh" ]]; then source "$LIB_DIR/commands/dashboard.sh"; run_dashboard; exit $?; fi
        ;;
    watermark)
        shift
        if [[ -f "$LIB_DIR/commands/watermark.sh" ]]; then source "$LIB_DIR/commands/watermark.sh"; run_watermark "$@"; exit $?; fi
        ;;
    subtitle)
        shift
        if [[ -f "$LIB_DIR/commands/subtitle.sh" ]]; then source "$LIB_DIR/commands/subtitle.sh"; run_subtitle "$@"; exit $?; fi
        ;;
    
    llm-lists)
        shift
        if [[ -f "$LIB_DIR/commands/llm-lists.sh" ]]; then source "$LIB_DIR/commands/llm-lists.sh"; llm_lists "$@"; exit $?; fi
        ;;

    audio)
        shift
        if [[ -f "$LIB_DIR/commands/audio.sh" ]]; then source "$LIB_DIR/commands/audio.sh"; run_audio "$@"; exit $?; fi
        ;;

    ffmpeg)
        shift
        FFMPEG_PATH=$(get_ffmpeg_path)
        if [[ -x "$FFMPEG_PATH" ]]; then
            "$FFMPEG_PATH" "$@"
            exit $?
        else
            echo "❌ Error: Full-featured FFmpeg not found."
            exit 1
        fi
        ;;
        
    help|--help|-h)
        if [[ -f "$LIB_DIR/commands/help.sh" ]]; then
            source "$LIB_DIR/commands/help.sh"
            run_help "$@"
            exit $?
        fi
        ;;
    *)
        # Default behavior: Compression
        # If the first argument is a file (or anything else), treat it as a compression input
        if [[ -f "$LIB_DIR/commands/compress.sh" ]]; then
             source "$LIB_DIR/commands/compress.sh"
             run_compress "$@"
             exit $?
        else
            echo "❌ Error: Compression module not found."
            exit 1
        fi
        ;;
esac
